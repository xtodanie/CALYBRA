# agent/TRUTH_SNAPSHOT.md

This file is generated by `node scripts/truth.mjs`. Do not edit manually.

## Sources
- firestore.rules
- storage.rules
- firebase.json
- .firebaserc
- tests/**/*.test.ts

## Firebase Config
### Functions Sources
- calybra-database

### Emulators
- auth: 127.0.0.1:9099
- firestore: 127.0.0.1:8085
- functions: 127.0.0.1:5001
- hub: 127.0.0.1:4401
- logging: 127.0.0.1:4501
- storage: 127.0.0.1:9199
- ui: 127.0.0.1:4001

### .firebaserc Projects
- default: studio-5801368156-a6af7
- CALYBRA MVP: studio-5801368156-a6af7

## Firestore Rules Paths
- firestore.rules:85 | match /databases/{database}/documents {
- firestore.rules:227 | match /tenants/{tenantId} {
- firestore.rules:233 | match /monthCloses/{monthCloseId} {
- firestore.rules:282 | match /events/{eventId} {
- firestore.rules:287 | match /periods/{monthKey} {
- firestore.rules:295 | match /readmodels/{monthCloseId} {
- firestore.rules:302 | match /readmodels/{modelId}/{docId}/{subDocId} {
- firestore.rules:307 | match /readmodels/{modelId}/{docId} {
- firestore.rules:312 | match /exports/{monthKey} {
- firestore.rules:316 | match /artifacts/{artifactId} {
- firestore.rules:322 | match /fileAssets/{fileAssetId} {
- firestore.rules:357 | match /invoices/{invoiceId} {
- firestore.rules:366 | match /bankTx/{txId} {
- firestore.rules:375 | match /matches/{matchId} {
- firestore.rules:398 | match /users/{userId} {
- firestore.rules:403 | match /jobs/{jobId} {
- firestore.rules:410 | match /exceptions/{exceptionId} {

## Storage Rules Paths
- storage.rules:4 | match /b/{bucket}/o {
- storage.rules:14 | match /tenants/{tenantId}/{path=**} {

## Identity + RBAC Sources (from Firestore rules)
- firestore.rules:92 | function userPath() {
- firestore.rules:100 | function userData() {
- firestore.rules:104 | function tenantOfUser() {
- firestore.rules:108 | function roleOfUser() {
- firestore.rules:124 | function isServer() {

## Roles (from Firestore rules)
- ACCOUNTANT
- MANAGER
- OWNER

### Role References
- firestore.rules:243 | hasRole(["OWNER", "MANAGER", "ACCOUNTANT"])
- firestore.rules:268 | hasRole(["OWNER", "ACCOUNTANT"])
- firestore.rules:332 | hasRole(["OWNER", "MANAGER", "ACCOUNTANT"])

## Status Literals (from Firestore rules)
- CONFIRMED
- DELETED
- DRAFT
- FINALIZED
- PENDING
- PENDING_UPLOAD
- PROPOSED
- REJECTED

### Status References
- firestore.rules:184 | status == "CONFIRMED"
- firestore.rules:185 | status == "REJECTED"
- firestore.rules:191 | status == "FINALIZED"
- firestore.rules:197 | status == "DELETED"
- firestore.rules:209 | status == "FINALIZED"
- firestore.rules:217 | status == "FINALIZED"
- firestore.rules:239 | status == "DRAFT"
- firestore.rules:255 | status == "DRAFT"
- firestore.rules:270 | status != "FINALIZED"
- firestore.rules:328 | status == "PENDING_UPLOAD"
- firestore.rules:343 | status == "PENDING_UPLOAD"
- firestore.rules:344 | parseStatus == "PENDING"
- firestore.rules:380 | status == "PROPOSED"

## Access Rules (from Firestore rules)
### Allow Rules
- firestore.rules:222 | allow read, write: if false;
- firestore.rules:228 | allow read: if isTenantMember(tenantId);
- firestore.rules:229 | allow write: if isServer();
- firestore.rules:234 | allow read: if isTenantMember(tenantId);
- firestore.rules:237 | allow create: if (
- firestore.rules:261 | allow update: if (
- firestore.rules:279 | allow delete: if isServer();
- firestore.rules:283 | allow read: if isTenantMember(tenantId);
- firestore.rules:284 | allow write: if isServer();
- firestore.rules:288 | allow read: if isTenantMember(tenantId);
- firestore.rules:289 | allow write: if isServer();
- firestore.rules:296 | allow read: if isTenantMember(tenantId);
- firestore.rules:298 | allow create: if isServer();
- firestore.rules:299 | allow update, delete: if false;
- firestore.rules:303 | allow read: if isTenantMember(tenantId);
- firestore.rules:304 | allow write: if isServer();
- firestore.rules:308 | allow read: if isTenantMember(tenantId);
- firestore.rules:309 | allow write: if isServer();
- firestore.rules:313 | allow read: if isTenantMember(tenantId);
- firestore.rules:314 | allow write: if isServer();
- firestore.rules:317 | allow read: if isTenantMember(tenantId);
- firestore.rules:318 | allow write: if isServer();
- firestore.rules:323 | allow read: if isTenantMember(tenantId);
- firestore.rules:326 | allow create: if (
- firestore.rules:349 | allow update: if isServer()
- firestore.rules:354 | allow delete: if isServer();
- firestore.rules:358 | allow read: if isTenantMember(tenantId);
- firestore.rules:361 | allow write: if isServer()
- firestore.rules:367 | allow read: if isTenantMember(tenantId);
- firestore.rules:370 | allow write: if isServer()
- firestore.rules:376 | allow read: if isTenantMember(tenantId);
- firestore.rules:379 | allow create: if isServer()
- firestore.rules:385 | allow update: if isServer()
- firestore.rules:392 | allow delete: if isServer()
- firestore.rules:399 | allow read: if isSignedIn() && request.auth.uid == userId;
- firestore.rules:400 | allow write: if isServer();
- firestore.rules:404 | allow read: if userExists()
- firestore.rules:407 | allow write: if isServer();
- firestore.rules:411 | allow read: if userExists()
- firestore.rules:416 | allow create: if isServer()
- firestore.rules:422 | allow update: if isServer()
- firestore.rules:428 | allow delete: if isServer()

### Required Fields (hasAll)
- firestore.rules:114 | && userData().keys().hasAll(['tenantId'])
- firestore.rules:120 | && userData().keys().hasAll(['role'])
- firestore.rules:134 | function hasAll(required) {
- firestore.rules:137 | && request.resource.data.keys().hasAll(required);
- firestore.rules:142 | && data.keys().hasAll([key]);
- firestore.rules:244 | && hasAll([
- firestore.rules:333 | && hasAll([
- firestore.rules:405 | && resource.data.keys().hasAll(['tenantId'])
- firestore.rules:412 | && resource.data.keys().hasAll(['tenantId'])

### Field Allowlists (hasOnly)
- firestore.rules:128 | function hasOnly(allowed) {
- firestore.rules:131 | && request.resource.data.keys().hasOnly(allowed);
- firestore.rules:248 | && hasOnly([
- firestore.rules:337 | && hasOnly([

### Status Constraints (from rules)
- firestore.rules:184 | || resource.data.status == "CONFIRMED"
- firestore.rules:185 | || resource.data.status == "REJECTED";
- firestore.rules:191 | || resource.data.status == "FINALIZED";
- firestore.rules:197 | || resource.data.status == "DELETED";
- firestore.rules:209 | && get(/databases/$(database)/documents/tenants/$(tenantId)/monthCloses/$(monthCloseId)).data.status == "FINALIZED";
- firestore.rules:217 | && get(/databases/$(database)/documents/tenants/$(tenantId)/monthCloses/$(monthCloseId)).data.status == "FINALIZED";
- firestore.rules:239 | && request.resource.data.status == "DRAFT"
- firestore.rules:255 | && request.resource.data.status == "DRAFT"
- firestore.rules:270 | && resource.data.status != "FINALIZED"
- firestore.rules:328 | && request.resource.data.status == "PENDING_UPLOAD"
- firestore.rules:343 | && request.resource.data.status == "PENDING_UPLOAD"
- firestore.rules:344 | && (!hasKey(request.resource.data, 'parseStatus') || request.resource.data.parseStatus == "PENDING")
- firestore.rules:380 | && request.resource.data.status == "PROPOSED"

### Server-only Writes (derived from allow write: if isServer())
- firestore.rules:229 | /tenants/ | allow write: if isServer();
- firestore.rules:284 | /events/ | allow write: if isServer();
- firestore.rules:289 | /periods/ | allow write: if isServer();
- firestore.rules:304 | /readmodels/ | allow write: if isServer();
- firestore.rules:309 | /readmodels/ | allow write: if isServer();
- firestore.rules:314 | /exports/ | allow write: if isServer();
- firestore.rules:318 | /artifacts/ | allow write: if isServer();
- firestore.rules:400 | /users/ | allow write: if isServer();
- firestore.rules:407 | /jobs/ | allow write: if isServer();

## Test Observations
- Test files scanned: 9
### Roles in tests (sampled)
- tests\download-auth.test.ts:25 | "OWNER"
- tests\download-auth.test.ts:41 | "ACCOUNTANT"
- tests\download-auth.test.ts:51 | "VIEWER"
- tests\download-auth.test.ts:61 | "OWNER"
- tests\download-auth.test.ts:71 | "OWNER"
- tests\firestore.rules.test.ts:55 | "OWNER"
- tests\firestore.rules.test.ts:56 | "MANAGER"
- tests\firestore.rules.test.ts:57 | "VIEWER"
- tests\firestore.rules.test.ts:58 | "OWNER"
- tests\firestore.rules.test.ts:273 | "OWNER"
- tests\firestore.rules.test.ts:278 | "VIEWER"
- tests\invariants\rbac.test.ts:47 | "OWNER"
- tests\invariants\rbac.test.ts:48 | "MANAGER"
- tests\invariants\rbac.test.ts:49 | "ACCOUNTANT"
- tests\invariants\rbac.test.ts:50 | "VIEWER"
- tests\invariants\server-only-writes.test.ts:54 | "OWNER"
- tests\invariants\server-only-writes.test.ts:91 | "VIEWER"
- tests\invariants\server-only-writes.test.ts:95 | "MANAGER"
- tests\invariants\server-only-writes.test.ts:99 | "VIEWER"
- tests\invariants\status-transitions.test.ts:44 | "OWNER"
- tests\invariants\status-transitions.test.ts:45 | "ACCOUNTANT"
- tests\invariants\tenant-isolation.test.ts:47 | "OWNER"
- tests\invariants\tenant-isolation.test.ts:49 | "OWNER"
- tests\invariants.test.ts:69 | "OWNER"
- tests\invariants.test.ts:73 | "ACCOUNTANT"
- tests\invariants.test.ts:77 | "VIEWER"
- tests\invariants.test.ts:81 | "OWNER"

### Statuses in tests (sampled)
- tests\firestore.rules.test.ts:63 | "DRAFT"
- tests\firestore.rules.test.ts:74 | "DRAFT"
- tests\firestore.rules.test.ts:85 | "PENDING_UPLOAD"
- tests\firestore.rules.test.ts:129 | "PENDING"
- tests\firestore.rules.test.ts:130 | "PENDING_UPLOAD"
- tests\firestore.rules.test.ts:178 | "IN_REVIEW"
- tests\firestore.rules.test.ts:179 | "FINALIZED"
- tests\firestore.rules.test.ts:193 | "PENDING_UPLOAD"
- tests\firestore.rules.test.ts:194 | "PENDING"
- tests\firestore.rules.test.ts:207 | "PARSED"
- tests\firestore.rules.test.ts:259 | "PROPOSED"
- tests\invariants\rbac.test.ts:54 | "DRAFT"
- tests\invariants\rbac.test.ts:70 | "DRAFT"
- tests\invariants\rbac.test.ts:84 | "PENDING_UPLOAD"
- tests\invariants\server-only-writes.test.ts:57 | "DRAFT"
- tests\invariants\server-only-writes.test.ts:60 | "PROPOSED"
- tests\invariants\server-only-writes.test.ts:65 | "PENDING"
- tests\invariants\server-only-writes.test.ts:137 | "PROPOSED"
- tests\invariants\server-only-writes.test.ts:141 | "CONFIRMED"
- tests\invariants\server-only-writes.test.ts:146 | "PROPOSED"
- tests\invariants\server-only-writes.test.ts:192 | "PENDING"
- tests\invariants\status-transitions.test.ts:49 | "DRAFT"
- tests\invariants\status-transitions.test.ts:65 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:70 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:75 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:80 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:87 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:91 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:98 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:108 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:115 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:125 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:144 | "PENDING_UPLOAD"
- tests\invariants\status-transitions.test.ts:194 | "PROPOSED"
- tests\invariants\status-transitions.test.ts:205 | "CONFIRMED"
- tests\invariants\status-transitions.test.ts:210 | "CONFIRMED"
- tests\invariants\status-transitions.test.ts:215 | "REJECTED"
- tests\invariants\status-transitions.test.ts:222 | "CONFIRMED"
- tests\invariants\status-transitions.test.ts:233 | "REJECTED"
- tests\invariants\status-transitions.test.ts:247 | "CONFIRMED"
- tests\invariants\status-transitions.test.ts:261 | "PROPOSED"
- tests\invariants\tenant-isolation.test.ts:55 | "DRAFT"
- tests\invariants\tenant-isolation.test.ts:59 | "DRAFT"
- tests\invariants\tenant-isolation.test.ts:159 | "PENDING_UPLOAD"
- tests\invariants\tenant-isolation.test.ts:174 | "DRAFT"
- tests\invariants.test.ts:87 | "DRAFT"
- tests\invariants.test.ts:100 | "DRAFT"
- tests\invariants.test.ts:132 | "DRAFT"
- tests\invariants.test.ts:149 | "DRAFT"
- tests\invariants.test.ts:171 | "DRAFT"
- ... +16 more

## Canonical Path Model (derived)
- Model: Tenant subcollections (Model A)
