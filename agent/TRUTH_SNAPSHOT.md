# agent/TRUTH_SNAPSHOT.md

This file is generated by `node scripts/truth.mjs`. Do not edit manually.

## Sources
- firestore.rules
- storage.rules
- firebase.json
- .firebaserc
- tests/**/*.test.ts

## Firebase Config
### Functions Sources
- calybra-database

### Emulators
- auth: 127.0.0.1:9099
- firestore: 127.0.0.1:8080
- functions: 127.0.0.1:5001
- hub: 127.0.0.1:4401
- logging: 127.0.0.1:4501
- storage: 127.0.0.1:9199
- ui: 127.0.0.1:4001

### .firebaserc Projects
- default: studio-5801368156-a6af7

## Firestore Rules Paths
- firestore.rules:4 | match /databases/{database}/documents {
- firestore.rules:115 | match /tenants/{tenantId} {
- firestore.rules:121 | match /monthCloses/{monthCloseId} {
- firestore.rules:163 | match /fileAssets/{fileAssetId} {
- firestore.rules:192 | match /invoices/{invoiceId} {
- firestore.rules:197 | match /bankTx/{txId} {
- firestore.rules:202 | match /matches/{matchId} {
- firestore.rules:219 | match /users/{userId} {
- firestore.rules:224 | match /jobs/{jobId} {
- firestore.rules:231 | match /exceptions/{exceptionId} {

## Storage Rules Paths
- storage.rules:4 | match /b/{bucket}/o {
- storage.rules:14 | match /tenants/{tenantId}/{path=**} {

## Identity + RBAC Sources (from Firestore rules)
- firestore.rules:11 | function userPath() {
- firestore.rules:19 | function userData() {
- firestore.rules:23 | function tenantOfUser() {
- firestore.rules:27 | function roleOfUser() {
- firestore.rules:43 | function isServer() {

## Roles (from Firestore rules)
- ACCOUNTANT
- MANAGER
- OWNER

### Role References
- firestore.rules:126 | hasRole(["OWNER", "MANAGER", "ACCOUNTANT"])
- firestore.rules:149 | hasRole(["OWNER", "ACCOUNTANT"])
- firestore.rules:168 | hasRole(["OWNER", "MANAGER", "ACCOUNTANT"])

## Status Literals (from Firestore rules)
- CONFIRMED
- DELETED
- DRAFT
- FINALIZED
- PENDING
- PENDING_UPLOAD
- PROPOSED
- REJECTED

### Status References
- firestore.rules:95 | status == "CONFIRMED"
- firestore.rules:95 | status == "REJECTED"
- firestore.rules:100 | status == "FINALIZED"
- firestore.rules:105 | status == "DELETED"
- firestore.rules:138 | status == "DRAFT"
- firestore.rules:151 | status != "FINALIZED"
- firestore.rules:179 | status == "PENDING_UPLOAD"
- firestore.rules:180 | parseStatus == "PENDING"
- firestore.rules:207 | status == "PROPOSED"

## Access Rules (from Firestore rules)
### Allow Rules
- firestore.rules:110 | allow read, write: if false;
- firestore.rules:116 | allow read: if isTenantMember(tenantId);
- firestore.rules:117 | allow write: if isServer();
- firestore.rules:122 | allow read: if isTenantMember(tenantId);
- firestore.rules:125 | allow create: if userExists()
- firestore.rules:143 | allow update: if (
- firestore.rules:160 | allow delete: if isServer();
- firestore.rules:164 | allow read: if isTenantMember(tenantId);
- firestore.rules:167 | allow create: if userExists()
- firestore.rules:184 | allow update: if isServer()
- firestore.rules:189 | allow delete: if isServer() && !fileAssetIsTerminal();
- firestore.rules:193 | allow read: if isTenantMember(tenantId);
- firestore.rules:194 | allow write: if isServer();
- firestore.rules:198 | allow read: if isTenantMember(tenantId);
- firestore.rules:199 | allow write: if isServer();
- firestore.rules:203 | allow read: if isTenantMember(tenantId);
- firestore.rules:206 | allow create: if isServer()
- firestore.rules:210 | allow update: if isServer()
- firestore.rules:215 | allow delete: if isServer() && !matchIsTerminal();
- firestore.rules:220 | allow read: if isSignedIn() && request.auth.uid == userId;
- firestore.rules:221 | allow write: if isServer();
- firestore.rules:225 | allow read: if userExists()
- firestore.rules:228 | allow write: if isServer();
- firestore.rules:232 | allow read: if userExists()
- firestore.rules:235 | allow write: if isServer();

### Required Fields (hasAll)
- firestore.rules:33 | && userData().keys().hasAll(['tenantId'])
- firestore.rules:39 | && userData().keys().hasAll(['role'])
- firestore.rules:53 | function hasAll(required) {
- firestore.rules:56 | && request.resource.data.keys().hasAll(required);
- firestore.rules:127 | && hasAll([
- firestore.rules:169 | && hasAll([
- firestore.rules:226 | && resource.data.keys().hasAll(['tenantId'])
- firestore.rules:233 | && resource.data.keys().hasAll(['tenantId'])

### Field Allowlists (hasOnly)
- firestore.rules:47 | function hasOnly(allowed) {
- firestore.rules:50 | && request.resource.data.keys().hasOnly(allowed);
- firestore.rules:131 | && hasOnly([
- firestore.rules:173 | && hasOnly([

### Status Constraints (from rules)
- firestore.rules:95 | return resource.data.status == "CONFIRMED" || resource.data.status == "REJECTED";
- firestore.rules:100 | return resource.data.status == "FINALIZED";
- firestore.rules:105 | return resource.data.status == "DELETED";
- firestore.rules:138 | && request.resource.data.status == "DRAFT"
- firestore.rules:151 | && resource.data.status != "FINALIZED"
- firestore.rules:179 | && request.resource.data.status == "PENDING_UPLOAD"
- firestore.rules:180 | && (!('parseStatus' in request.resource.data) || request.resource.data.parseStatus == "PENDING")
- firestore.rules:207 | && request.resource.data.status == "PROPOSED";

### Server-only Writes (derived from allow write: if isServer())
- firestore.rules:117 | /tenants/ | allow write: if isServer();
- firestore.rules:194 | /invoices/ | allow write: if isServer();
- firestore.rules:199 | /bankTx/ | allow write: if isServer();
- firestore.rules:221 | /users/ | allow write: if isServer();
- firestore.rules:228 | /jobs/ | allow write: if isServer();
- firestore.rules:235 | /exceptions/ | allow write: if isServer();

## Test Observations
- Test files scanned: 8
### Roles in tests (sampled)
- tests\download-auth.test.ts:25 | "OWNER"
- tests\download-auth.test.ts:41 | "ACCOUNTANT"
- tests\download-auth.test.ts:51 | "VIEWER"
- tests\download-auth.test.ts:61 | "OWNER"
- tests\download-auth.test.ts:71 | "OWNER"
- tests\firestore.rules.test.ts:59 | "OWNER"
- tests\firestore.rules.test.ts:60 | "MANAGER"
- tests\firestore.rules.test.ts:61 | "VIEWER"
- tests\firestore.rules.test.ts:62 | "OWNER"
- tests\firestore.rules.test.ts:253 | "OWNER"
- tests\firestore.rules.test.ts:258 | "VIEWER"
- tests\invariants\rbac.test.ts:49 | "OWNER"
- tests\invariants\rbac.test.ts:50 | "MANAGER"
- tests\invariants\rbac.test.ts:51 | "ACCOUNTANT"
- tests\invariants\rbac.test.ts:52 | "VIEWER"
- tests\invariants\server-only-writes.test.ts:51 | "OWNER"
- tests\invariants\server-only-writes.test.ts:82 | "VIEWER"
- tests\invariants\server-only-writes.test.ts:86 | "MANAGER"
- tests\invariants\server-only-writes.test.ts:90 | "VIEWER"
- tests\invariants\status-transitions.test.ts:46 | "OWNER"
- tests\invariants\status-transitions.test.ts:47 | "ACCOUNTANT"
- tests\invariants\tenant-isolation.test.ts:50 | "OWNER"
- tests\invariants\tenant-isolation.test.ts:52 | "OWNER"
- tests\invariants.test.ts:73 | "OWNER"
- tests\invariants.test.ts:77 | "ACCOUNTANT"
- tests\invariants.test.ts:81 | "VIEWER"
- tests\invariants.test.ts:85 | "OWNER"

### Statuses in tests (sampled)
- tests\firestore.rules.test.ts:67 | "DRAFT"
- tests\firestore.rules.test.ts:78 | "DRAFT"
- tests\firestore.rules.test.ts:89 | "PENDING_UPLOAD"
- tests\firestore.rules.test.ts:133 | "PENDING"
- tests\firestore.rules.test.ts:134 | "PENDING_UPLOAD"
- tests\firestore.rules.test.ts:159 | "FINALIZED"
- tests\firestore.rules.test.ts:173 | "PENDING_UPLOAD"
- tests\firestore.rules.test.ts:174 | "PENDING"
- tests\firestore.rules.test.ts:187 | "PARSED"
- tests\firestore.rules.test.ts:239 | "PROPOSED"
- tests\invariants\rbac.test.ts:56 | "DRAFT"
- tests\invariants\rbac.test.ts:72 | "DRAFT"
- tests\invariants\rbac.test.ts:86 | "PENDING_UPLOAD"
- tests\invariants\server-only-writes.test.ts:55 | "PROPOSED"
- tests\invariants\server-only-writes.test.ts:56 | "PENDING"
- tests\invariants\server-only-writes.test.ts:128 | "PROPOSED"
- tests\invariants\server-only-writes.test.ts:132 | "CONFIRMED"
- tests\invariants\server-only-writes.test.ts:136 | "CONFIRMED"
- tests\invariants\server-only-writes.test.ts:142 | "PENDING"
- tests\invariants\status-transitions.test.ts:51 | "DRAFT"
- tests\invariants\status-transitions.test.ts:67 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:72 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:77 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:82 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:89 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:93 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:100 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:110 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:117 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:127 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:146 | "PENDING_UPLOAD"
- tests\invariants\status-transitions.test.ts:196 | "PROPOSED"
- tests\invariants\status-transitions.test.ts:207 | "CONFIRMED"
- tests\invariants\status-transitions.test.ts:212 | "CONFIRMED"
- tests\invariants\status-transitions.test.ts:217 | "REJECTED"
- tests\invariants\status-transitions.test.ts:224 | "CONFIRMED"
- tests\invariants\status-transitions.test.ts:235 | "REJECTED"
- tests\invariants\status-transitions.test.ts:249 | "CONFIRMED"
- tests\invariants\status-transitions.test.ts:263 | "PROPOSED"
- tests\invariants\tenant-isolation.test.ts:58 | "DRAFT"
- tests\invariants\tenant-isolation.test.ts:62 | "DRAFT"
- tests\invariants\tenant-isolation.test.ts:98 | "PENDING_UPLOAD"
- tests\invariants\tenant-isolation.test.ts:113 | "DRAFT"
- tests\invariants.test.ts:91 | "DRAFT"
- tests\invariants.test.ts:104 | "DRAFT"
- tests\invariants.test.ts:136 | "DRAFT"
- tests\invariants.test.ts:153 | "DRAFT"
- tests\invariants.test.ts:175 | "DRAFT"
- tests\invariants.test.ts:204 | "IN_REVIEW"
- tests\invariants.test.ts:209 | "FINALIZED"
- ... +14 more

## Canonical Path Model (derived)
- Model: Tenant subcollections (Model A)
