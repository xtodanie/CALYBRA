# agent/TRUTH_SNAPSHOT.md

This file is generated by `node scripts/truth.mjs`. Do not edit manually.

## Sources
- firestore.rules
- storage.rules
- firebase.json
- .firebaserc
- tests/**/*.test.ts

## Firebase Config
### Functions Sources
- calybra-database

### Emulators
- auth: 127.0.0.1:9099
- firestore: 127.0.0.1:8080
- functions: 127.0.0.1:5001
- hub: 127.0.0.1:4401
- logging: 127.0.0.1:4501
- storage: 127.0.0.1:9199
- ui: 127.0.0.1:4001

### .firebaserc Projects
- default: studio-5801368156-a6af7
- CALYBRA MVP: studio-5801368156-a6af7

## Firestore Rules Paths
- firestore.rules:85 | match /databases/{database}/documents {
- firestore.rules:207 | match /tenants/{tenantId} {
- firestore.rules:213 | match /monthCloses/{monthCloseId} {
- firestore.rules:262 | match /events/{eventId} {
- firestore.rules:267 | match /periods/{monthKey} {
- firestore.rules:272 | match /readmodels/{modelId}/{docId}/{subDocId} {
- firestore.rules:277 | match /readmodels/{modelId}/{docId} {
- firestore.rules:282 | match /exports/{monthKey} {
- firestore.rules:286 | match /artifacts/{artifactId} {
- firestore.rules:292 | match /fileAssets/{fileAssetId} {
- firestore.rules:327 | match /invoices/{invoiceId} {
- firestore.rules:332 | match /bankTx/{txId} {
- firestore.rules:337 | match /matches/{matchId} {
- firestore.rules:354 | match /users/{userId} {
- firestore.rules:359 | match /jobs/{jobId} {
- firestore.rules:366 | match /exceptions/{exceptionId} {

## Storage Rules Paths
- storage.rules:4 | match /b/{bucket}/o {
- storage.rules:14 | match /tenants/{tenantId}/{path=**} {

## Identity + RBAC Sources (from Firestore rules)
- firestore.rules:92 | function userPath() {
- firestore.rules:100 | function userData() {
- firestore.rules:104 | function tenantOfUser() {
- firestore.rules:108 | function roleOfUser() {
- firestore.rules:124 | function isServer() {

## Roles (from Firestore rules)
- ACCOUNTANT
- MANAGER
- OWNER

### Role References
- firestore.rules:223 | hasRole(["OWNER", "MANAGER", "ACCOUNTANT"])
- firestore.rules:248 | hasRole(["OWNER", "ACCOUNTANT"])
- firestore.rules:302 | hasRole(["OWNER", "MANAGER", "ACCOUNTANT"])

## Status Literals (from Firestore rules)
- CONFIRMED
- DELETED
- DRAFT
- FINALIZED
- PENDING
- PENDING_UPLOAD
- PROPOSED
- REJECTED

### Status References
- firestore.rules:184 | status == "CONFIRMED"
- firestore.rules:185 | status == "REJECTED"
- firestore.rules:191 | status == "FINALIZED"
- firestore.rules:197 | status == "DELETED"
- firestore.rules:219 | status == "DRAFT"
- firestore.rules:235 | status == "DRAFT"
- firestore.rules:250 | status != "FINALIZED"
- firestore.rules:298 | status == "PENDING_UPLOAD"
- firestore.rules:313 | status == "PENDING_UPLOAD"
- firestore.rules:314 | parseStatus == "PENDING"
- firestore.rules:342 | status == "PROPOSED"

## Access Rules (from Firestore rules)
### Allow Rules
- firestore.rules:202 | allow read, write: if false;
- firestore.rules:208 | allow read: if isTenantMember(tenantId);
- firestore.rules:209 | allow write: if isServer();
- firestore.rules:214 | allow read: if isTenantMember(tenantId);
- firestore.rules:217 | allow create: if (
- firestore.rules:241 | allow update: if (
- firestore.rules:259 | allow delete: if isServer();
- firestore.rules:263 | allow read: if isTenantMember(tenantId);
- firestore.rules:264 | allow write: if isServer();
- firestore.rules:268 | allow read: if isTenantMember(tenantId);
- firestore.rules:269 | allow write: if isServer();
- firestore.rules:273 | allow read: if isTenantMember(tenantId);
- firestore.rules:274 | allow write: if isServer();
- firestore.rules:278 | allow read: if isTenantMember(tenantId);
- firestore.rules:279 | allow write: if isServer();
- firestore.rules:283 | allow read: if isTenantMember(tenantId);
- firestore.rules:284 | allow write: if isServer();
- firestore.rules:287 | allow read: if isTenantMember(tenantId);
- firestore.rules:288 | allow write: if isServer();
- firestore.rules:293 | allow read: if isTenantMember(tenantId);
- firestore.rules:296 | allow create: if (
- firestore.rules:319 | allow update: if isServer()
- firestore.rules:324 | allow delete: if isServer();
- firestore.rules:328 | allow read: if isTenantMember(tenantId);
- firestore.rules:329 | allow write: if isServer();
- firestore.rules:333 | allow read: if isTenantMember(tenantId);
- firestore.rules:334 | allow write: if isServer();
- firestore.rules:338 | allow read: if isTenantMember(tenantId);
- firestore.rules:341 | allow create: if isServer()
- firestore.rules:345 | allow update: if isServer()
- firestore.rules:350 | allow delete: if isServer();
- firestore.rules:355 | allow read: if isSignedIn() && request.auth.uid == userId;
- firestore.rules:356 | allow write: if isServer();
- firestore.rules:360 | allow read: if userExists()
- firestore.rules:363 | allow write: if isServer();
- firestore.rules:367 | allow read: if userExists()
- firestore.rules:370 | allow write: if isServer();

### Required Fields (hasAll)
- firestore.rules:114 | && userData().keys().hasAll(['tenantId'])
- firestore.rules:120 | && userData().keys().hasAll(['role'])
- firestore.rules:134 | function hasAll(required) {
- firestore.rules:137 | && request.resource.data.keys().hasAll(required);
- firestore.rules:142 | && data.keys().hasAll([key]);
- firestore.rules:224 | && hasAll([
- firestore.rules:303 | && hasAll([
- firestore.rules:361 | && resource.data.keys().hasAll(['tenantId'])
- firestore.rules:368 | && resource.data.keys().hasAll(['tenantId'])

### Field Allowlists (hasOnly)
- firestore.rules:128 | function hasOnly(allowed) {
- firestore.rules:131 | && request.resource.data.keys().hasOnly(allowed);
- firestore.rules:228 | && hasOnly([
- firestore.rules:307 | && hasOnly([

### Status Constraints (from rules)
- firestore.rules:184 | || resource.data.status == "CONFIRMED"
- firestore.rules:185 | || resource.data.status == "REJECTED";
- firestore.rules:191 | || resource.data.status == "FINALIZED";
- firestore.rules:197 | || resource.data.status == "DELETED";
- firestore.rules:219 | && request.resource.data.status == "DRAFT"
- firestore.rules:235 | && request.resource.data.status == "DRAFT"
- firestore.rules:250 | && resource.data.status != "FINALIZED"
- firestore.rules:298 | && request.resource.data.status == "PENDING_UPLOAD"
- firestore.rules:313 | && request.resource.data.status == "PENDING_UPLOAD"
- firestore.rules:314 | && (!hasKey(request.resource.data, 'parseStatus') || request.resource.data.parseStatus == "PENDING")
- firestore.rules:342 | && request.resource.data.status == "PROPOSED";

### Server-only Writes (derived from allow write: if isServer())
- firestore.rules:209 | /tenants/ | allow write: if isServer();
- firestore.rules:264 | /events/ | allow write: if isServer();
- firestore.rules:269 | /periods/ | allow write: if isServer();
- firestore.rules:274 | /readmodels/ | allow write: if isServer();
- firestore.rules:279 | /readmodels/ | allow write: if isServer();
- firestore.rules:284 | /exports/ | allow write: if isServer();
- firestore.rules:288 | /artifacts/ | allow write: if isServer();
- firestore.rules:329 | /invoices/ | allow write: if isServer();
- firestore.rules:334 | /bankTx/ | allow write: if isServer();
- firestore.rules:356 | /users/ | allow write: if isServer();
- firestore.rules:363 | /jobs/ | allow write: if isServer();
- firestore.rules:370 | /exceptions/ | allow write: if isServer();

## Test Observations
- Test files scanned: 8
### Roles in tests (sampled)
- tests\download-auth.test.ts:25 | "OWNER"
- tests\download-auth.test.ts:41 | "ACCOUNTANT"
- tests\download-auth.test.ts:51 | "VIEWER"
- tests\download-auth.test.ts:61 | "OWNER"
- tests\download-auth.test.ts:71 | "OWNER"
- tests\firestore.rules.test.ts:53 | "OWNER"
- tests\firestore.rules.test.ts:54 | "MANAGER"
- tests\firestore.rules.test.ts:55 | "VIEWER"
- tests\firestore.rules.test.ts:56 | "OWNER"
- tests\firestore.rules.test.ts:271 | "OWNER"
- tests\firestore.rules.test.ts:276 | "VIEWER"
- tests\invariants\rbac.test.ts:45 | "OWNER"
- tests\invariants\rbac.test.ts:46 | "MANAGER"
- tests\invariants\rbac.test.ts:47 | "ACCOUNTANT"
- tests\invariants\rbac.test.ts:48 | "VIEWER"
- tests\invariants\server-only-writes.test.ts:51 | "OWNER"
- tests\invariants\server-only-writes.test.ts:86 | "VIEWER"
- tests\invariants\server-only-writes.test.ts:90 | "MANAGER"
- tests\invariants\server-only-writes.test.ts:94 | "VIEWER"
- tests\invariants\status-transitions.test.ts:42 | "OWNER"
- tests\invariants\status-transitions.test.ts:43 | "ACCOUNTANT"
- tests\invariants\tenant-isolation.test.ts:45 | "OWNER"
- tests\invariants\tenant-isolation.test.ts:47 | "OWNER"
- tests\invariants.test.ts:67 | "OWNER"
- tests\invariants.test.ts:71 | "ACCOUNTANT"
- tests\invariants.test.ts:75 | "VIEWER"
- tests\invariants.test.ts:79 | "OWNER"

### Statuses in tests (sampled)
- tests\firestore.rules.test.ts:61 | "DRAFT"
- tests\firestore.rules.test.ts:72 | "DRAFT"
- tests\firestore.rules.test.ts:83 | "PENDING_UPLOAD"
- tests\firestore.rules.test.ts:127 | "PENDING"
- tests\firestore.rules.test.ts:128 | "PENDING_UPLOAD"
- tests\firestore.rules.test.ts:176 | "IN_REVIEW"
- tests\firestore.rules.test.ts:177 | "FINALIZED"
- tests\firestore.rules.test.ts:191 | "PENDING_UPLOAD"
- tests\firestore.rules.test.ts:192 | "PENDING"
- tests\firestore.rules.test.ts:205 | "PARSED"
- tests\firestore.rules.test.ts:257 | "PROPOSED"
- tests\invariants\rbac.test.ts:52 | "DRAFT"
- tests\invariants\rbac.test.ts:68 | "DRAFT"
- tests\invariants\rbac.test.ts:82 | "PENDING_UPLOAD"
- tests\invariants\server-only-writes.test.ts:55 | "PROPOSED"
- tests\invariants\server-only-writes.test.ts:60 | "PENDING"
- tests\invariants\server-only-writes.test.ts:132 | "PROPOSED"
- tests\invariants\server-only-writes.test.ts:136 | "CONFIRMED"
- tests\invariants\server-only-writes.test.ts:141 | "PROPOSED"
- tests\invariants\server-only-writes.test.ts:187 | "PENDING"
- tests\invariants\status-transitions.test.ts:47 | "DRAFT"
- tests\invariants\status-transitions.test.ts:63 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:68 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:73 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:78 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:85 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:89 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:96 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:106 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:113 | "FINALIZED"
- tests\invariants\status-transitions.test.ts:123 | "IN_REVIEW"
- tests\invariants\status-transitions.test.ts:142 | "PENDING_UPLOAD"
- tests\invariants\status-transitions.test.ts:192 | "PROPOSED"
- tests\invariants\status-transitions.test.ts:203 | "CONFIRMED"
- tests\invariants\status-transitions.test.ts:208 | "CONFIRMED"
- tests\invariants\status-transitions.test.ts:213 | "REJECTED"
- tests\invariants\status-transitions.test.ts:220 | "CONFIRMED"
- tests\invariants\status-transitions.test.ts:231 | "REJECTED"
- tests\invariants\status-transitions.test.ts:245 | "CONFIRMED"
- tests\invariants\status-transitions.test.ts:259 | "PROPOSED"
- tests\invariants\tenant-isolation.test.ts:53 | "DRAFT"
- tests\invariants\tenant-isolation.test.ts:57 | "DRAFT"
- tests\invariants\tenant-isolation.test.ts:157 | "PENDING_UPLOAD"
- tests\invariants\tenant-isolation.test.ts:172 | "DRAFT"
- tests\invariants.test.ts:85 | "DRAFT"
- tests\invariants.test.ts:98 | "DRAFT"
- tests\invariants.test.ts:130 | "DRAFT"
- tests\invariants.test.ts:147 | "DRAFT"
- tests\invariants.test.ts:169 | "DRAFT"
- tests\invariants.test.ts:198 | "IN_REVIEW"
- ... +15 more

## Canonical Path Model (derived)
- Model: Tenant subcollections (Model A)
