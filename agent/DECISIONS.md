# agent/DECISIONS.md

## Purpose
This is the Architectural Decision Record (ADR) log for Calybra. Any meaningful change in:
- architecture model (paths)
- roles or RBAC policy
- status vocabulary / state machines
- client vs server authority
- CI enforcement
- dependencies/toolchain pinning
must be recorded here BEFORE implementation (or immediately if discovered mid-fix).

## Rules
- Decisions must be explicit and reversible.
- Every decision must state consequences.
- No “silent assumptions”.

---

## ADR Index
- ADR-0001: Tenant Isolation is Non-Negotiable
- ADR-0002: Server-Authoritative User Provisioning
- ADR-0003: Truth Lock + Consistency Gates Required
- ADR-0004: Proof-First Releases (No “Proof Pending”)
- ADR-0005: Invariant Test Suite Enforced in CI
- ADR-0006: Smallest Shippable Increment (SSI) + Max Two Surfaces Rule- ADR-0007: Truth Snapshot Committed Artifact
- ADR-0008: Server-Only Invoices/Matches + MonthCloseStatus IN_REVIEW + Tenant-Scoped FileAsset Downloads
---

## ADR-0001: Tenant Isolation is Non-Negotiable
**Status:** Accepted  
**Decision:** All tenant-owned data must be isolated. A user can only access documents belonging to their tenant as defined by the canonical user profile (`users/{uid}.tenantId`).  
**Rationale:** Prevents data leakage across tenants (P0).  
**Consequences:** Rules complexity increases; tests must cover cross-tenant denial across all relevant collections.

---

## ADR-0002: Server-Authoritative User Provisioning
**Status:** Accepted  
**Decision:** `users/{uid}` and any tenant membership primitives are created server-side (Cloud Functions / Admin SDK). Clients must never create or mutate user identity documents.  
**Rationale:** Removes race conditions and ensures tenantId/role cannot be forged.  
**Consequences:** Onboarding requires server pipeline availability; tests must seed user docs as admin context.

---

## ADR-0003: Truth Lock + Consistency Gates Required
**Status:** Accepted  
**Decision:** The repo’s primary sources (rules/tests/firebase config) are the canonical truth. A Truth Snapshot is generated and a Consistency Gate fails CI if docs/contracts/seed/schemas drift.  
**Rationale:** Prevents agent-induced architecture drift and eliminates “consistent-with-itself but wrong” changes.  
**Consequences:** Slight overhead in CI; faster debugging and fewer regressions.

---

## ADR-0004: Proof-First Releases (No “Proof Pending”)
**Status:** Accepted  
**Decision:** `agent/RELEASE.md` may only be updated after proofs are executed and PASS results are recorded. No release notes with “proof pending”.  
**Rationale:** Prevents false confidence and shipping broken builds.  
**Consequences:** Work-in-progress is tracked in TASKS only until proofs pass.

---

## ADR-0005: Invariant Test Suite Enforced in CI
**Status:** Accepted  
**Decision:** Add and enforce `tests/invariants/**` to prevent regressions in tenant isolation, forbidden client fields, and status transitions.  
**Rationale:** Rules tests alone do not catch all drift; invariants enforce global correctness.  
**Consequences:** Additional test time; requires seed/profile setup in emulator tests.

---

## ADR-0006: Smallest Shippable Increment (SSI) + Max Two Surfaces Rule
**Status:** Accepted  
**Decision:** Work is split into SSIs that touch at most two surfaces. Examples: Rules+Tests, UI+Domain, Scripts+CI. Anything larger must be split or explicitly justified.  
**Rationale:** Keeps diffs reviewable and reduces blast radius.  
**Consequences:** More PRs/commits, but far fewer regressions.

---

## ADR-0007: Truth Snapshot Committed Artifact
**Status:** Accepted  
**Decision:** `agent/TRUTH_SNAPSHOT.md` is generated by `node scripts/truth.mjs` and committed to the repo (not a CI-only artifact).  
**Rationale:** Ensures the snapshot is reviewable in PRs and eliminates CI-vs-local drift ambiguity.  
**Consequences:** Developers must regenerate the snapshot when rules/tests change. Consistency gate fails if stale.

---

## ADR Template
**ADR-XXXX: Title**  
Status: Proposed | Accepted | Rejected  
Decision:  
Rationale:  
Consequences:  
Proof requirements (tests/commands):  
Rollback approach:

---

## ADR-0008: Server-Only Invoices/Matches + MonthCloseStatus IN_REVIEW + Tenant-Scoped FileAsset Downloads
**Status:** Accepted  
**Decision:**
- Enforce server-only writes for `invoices` and `matches` in Firestore rules.
- Adopt `IN_REVIEW` as a valid `monthCloses.status` value across contracts and schemas.
- Require file asset downloads to read from `tenants/{tenantId}/fileAssets/{fileAssetId}` only.
**Rationale:**
- Aligns authority boundaries with security model and eliminates client-forgeable financial writes.
- Matches UI workflow state already in use.
- Fixes the download path drift and enforces tenant isolation for file assets.
**Consequences:**
- UI and docs must not assume client can write invoices/matches.
- Rules tests updated to deny client writes for invoices/matches.
- Functions must use tenant-scoped fileAsset path for download URLs.
**Proof requirements (tests/commands):**
- `npm run truth-lock`
- `npm run lint`
- `npm run typecheck`
- `firebase emulators:exec --only firestore "npm test"`
- `npm --prefix functions run build`
- `npm --prefix calybra-database run build`
**Rollback approach:**
- Revert ADR + rule changes + docs, redeploy rules/functions, rerun proofs.

---

## ADR-0009: Defense-in-Depth Status Transition Enforcement at Rules Level
**Status:** Accepted  
**Decision:**
- Firestore rules now enforce status transition validity for ALL writes, including server (admin) writes.
- Terminal states (FINALIZED for monthCloses, DELETED for fileAssets, CONFIRMED/REJECTED for matches) are immutable at the rules level.
- Server writes are now constrained: if changing status, the transition must be in the allowed transition table.
- Added helper functions: `statusChanging()`, `monthCloseIsTerminal()`, `fileAssetIsTerminal()`, `matchIsTerminal()`.
- Match creation now requires status=PROPOSED at rules level.
**Rationale:**
- Provides defense-in-depth: even if server code has a bug, rules prevent illegal state changes.
- Terminal state immutability prevents accidental corruption of finalized records.
- Transition tables in rules duplicate server-side logic intentionally for redundancy.
**Consequences:**
- Server code that attempts illegal transitions will be denied by rules.
- All status machines are now enforced at two layers: Cloud Functions + Firestore Rules.
- Tests added for server illegal transition denial in `tests/invariants/status-transitions.test.ts`.
**Proof requirements (tests/commands):**
- `npm run truth-lock`
- `npm run lint`
- `npm run typecheck`
- `firebase emulators:exec --only firestore "npm test"`
- `npm --prefix calybra-database run build`
**Rollback approach:**
- Revert firestore.rules to allow server writes without transition checks.
- Remove new test cases.
- Redeploy rules.
