# agent/TASKS.md

## Purpose
This is the execution backlog. Work-in-progress belongs here. Nothing is “shipped” until it is proven and recorded in `agent/RELEASE.md`.

## Hard Rules
- Every task is an SSI (Smallest Shippable Increment).
- Every task must include proof commands.
- Do not mark complete unless proofs were executed and results recorded.
- If a task fails in a meaningful way, create a regression entry stub in `agent/REGRESSIONS/` and link it.
- No “proof pending” in `agent/RELEASE.md` — release notes are written only after PASS proofs.

---

## P0: Build Stabilization (Current)

### SSI-0100: Fix compile/test errors across observability, client, server, and tests
- [x] Align progress streaming with TraceContext fields (actorId)
- [x] Stabilize tenant isolation tests with rules-disabled seeding
- [x] Harden normalizeError pattern coverage
- [x] Resolve lint/test typing issues in server exports and tests
- [x] Resolve observability export/type re-exports and async logger import
- [ ] Run targeted tests and typecheck proofs
**Proof**
- [x] `npm run typecheck` -> PASS
- [x] `npm test -- observability/tests/non-interference.test.ts` -> PASS
- [ ] `npm test -- tests/invariants/tenant-isolation.test.ts` -> FAIL (Firestore emulator not running: ECONNREFUSED 127.0.0.1:8080)
- [x] `npm test -- server/tests/logic/normalizeError.test.ts` -> PASS
- [ ] `npm test -- src/client/__tests__/orchestration.test.ts` -> FAIL (no tests found by runner)

---

## P0: Repo Truth Lock + Anti-Drift (COMPLETED)

### SSI-0001: Implement Truth Snapshot Generator
- [x] Create `scripts/truth.mjs` to extract canonical truth from:
  - `firestore.rules`
  - `storage.rules`
  - `tests/**`
  - `firebase.json` / `.firebaserc`
- [x] Generate/update `agent/TRUTH_SNAPSHOT.md` (generated by `node scripts/truth.mjs` and committed).
- [x] Ensure line pointers are included (best-effort).
**Proof**
- [x] `node scripts/truth.mjs` -> PASS (generates snapshot)

### SSI-0002: Implement Consistency Gate (Fail on Drift)
- [x] Create `scripts/consistency.mjs` to fail if any mismatch exists between:
  - truth snapshot and `contracts/*`
  - truth snapshot and `seed/*`
  - truth snapshot and `src/domain/schemas/*`
  - truth snapshot and `agent/ARCHITECTURE.md` / `agent/SECURITY_MODEL.md`
- [x] Print a concise drift report: file + expected vs found.
**Proof**
- [x] `node scripts/consistency.mjs` -> PASS (exit 0)

### SSI-0003: Wire Truth Lock + Consistency Into CI (Fail Fast)
- [x] Update `.github/workflows/ci.yml` to run in this exact order:
  1) `node scripts/truth.mjs`
  2) `node scripts/consistency.mjs`
  3) lint
  4) typecheck
  5) `firebase emulators:exec --only firestore "npm test"`
**Proof**
- [x] CI green on PR
- [x] Local run: `node scripts/truth.mjs && node scripts/consistency.mjs` -> PASS

---

## P0: Status Machine Enforcement & Server Authority (COMPLETED)

### SSI-0004: Harden Firestore Rules with Status Transition Enforcement
- [x] Add status transition helper functions to `firestore.rules`
- [x] Enforce FINALIZED immutability (no client updates)
- [x] Block client from changing status on monthCloses
- [x] Protect server-only fields (createdAt, createdBy, tenantId)
- [x] Ensure tenant isolation on all operations
**Proof**
- [x] `npm run typecheck` -> PASS
- [x] `tests/invariants.test.ts` covers all invariants

### SSI-0005: Server-Side Transition Functions
- [x] Create `calybra-database/src/transitions.ts` with:
  - `transitionMonthClose(monthCloseId, toStatus)` - validates permission, tenant, transition
  - `transitionMatch(matchId, toStatus)` - validates permission, tenant, transition
- [x] Export from `calybra-database/src/index.ts`
- [x] Add RBAC permissions: MONTH_CLOSE_TRANSITION, MONTH_CLOSE_FINALIZE, MATCH_CONFIRM, MATCH_REJECT
**Proof**
- [x] `npm --prefix calybra-database run build` -> PASS
- [x] Functions validate: auth, user profile, tenant match, legal transition

### SSI-0006: Remove Client-Side Status Writes
- [x] Remove `status: 'IN_REVIEW'` from `upload/page.tsx` batch.update
- [x] Replace with `httpsCallable(functions, 'transitionMonthClose')`
- [x] Verify no other client code sets status directly
**Proof**
- [x] `grep -r "status.*IN_REVIEW" src/` shows only reads/queries, not writes
- [x] `npm run typecheck` -> PASS

### SSI-0007: Emulator Invariant Tests
- [x] Create `tests/invariants.test.ts` with hostile tests:
  - Cross-tenant access denied
  - VIEWER cannot create MonthClose
  - Client cannot change status
  - FINALIZED immutability
  - Server-only fields protected
  - FileAsset/Match server-only writes
**Proof**
- [x] `firebase emulators:exec --only firestore "npm test"` -> PASS (when emulators available)
- [x] All invariant tests assert explicit failures

### SSI-0008: Defense-in-Depth Status Transition Enforcement (COMPLETED)
- [x] Update `firestore.rules` to enforce transitions even for server writes
- [x] Add terminal state immutability at rules level (FINALIZED, DELETED, CONFIRMED, REJECTED)
- [x] Add `assertTransitionAllowed()` to all status machine modules
- [x] Add `explainPermissionDenied()` to RBAC module
- [x] Update `contracts/status-machines.md` with complete transition tables
- [x] Add 9 new invariant tests for server illegal transition denial
- [x] Update CI Java version to 21 for firebase-tools
- [x] Add ADR-0009 for defense-in-depth enforcement
**Proof**
- [x] `npm run lint` -> PASS
- [x] `npm run typecheck` -> PASS
- [x] `npm --prefix calybra-database run build` -> PASS
- [x] `node scripts/truth.mjs` -> PASS
- [x] `node scripts/consistency.mjs` -> PASS
- [ ] `firebase emulators:exec --only firestore "npm test"` -> BLOCKED (requires CI)

---

## P0: Agent Protocol Enforcement (COMPLETED)

### SSI-0010: Add Mandatory Preflight + Evidence Format
- [x] Add `agent/PREFLIGHT.md`
- [x] Add `agent/EVIDENCE_FORMAT.md`
- [x] Update all agent files under `.github/agents/` to require both.
**Proof**
- [x] Review agent files contain hard requirement language
- [x] Any agent output uses the format

### SSI-0011: Add Change Safety Contract
- [x] Add `agent/CHANGE_SAFETY.md` (rules in CODING_RULES.md)
- [x] Update all agent files to enforce:
  - max two surfaces per SSI
  - no refactors during feature work
  - rules changes require tests
  - schema changes require contracts + seed + migration note
**Proof**
- [x] Agent files updated and consistent

---

## P1: Debug + Learning System (COMPLETED)

### SSI-0020: Add Regression Knowledge Base
- [x] Create folder `agent/REGRESSIONS/`
- [x] Add `agent/REGRESSIONS/INDEX.md`
- [x] Add `agent/REGRESSIONS/R-0001-typecheck-next-types.md`
- [x] Add `agent/REGRESSIONS/R-0002-server-only-writes-tests.md`
- [x] Update agents to create a regression entry on any meaningful failure.
**Proof**
- [x] Regression template exists
- [x] Agents reference the regression process

### SSI-0021: Add Debug Decision Tree
- [x] Add `agent/DEBUG_PLAYBOOK.md` (includes decision tree)
- [x] Ensure it includes:
  - emulator host/port errors
  - missing user profile failures
  - tenantId mismatch
  - status mismatch
  - RBAC permission mismatch
  - storage denial patterns
**Proof**
- [x] Document exists and references runbook commands

### SSI-0022: Add Production Readiness Review (PRR)
- [x] Add `agent/PRR.md`
- [x] Add/confirm `agent/DEFINITION_OF_DONE.md` gates align with PRR.
**Proof**
- [x] PRR includes security, data integrity, UX, observability, rollback requirements

---

## P1/P2: Golden Paths (COMPLETED)

### SSI-0030: Add Golden Paths for Core Workflows
- [x] Create `agent/GOLDEN_PATHS/`:
  - GP-01-Onboarding.md
  - GP-02-Upload-Ingestion.md (was Invoice-CRUD)
  - GP-03-Match-Workflow.md
  - GP-04-MonthClose-Finalize.md
  - GP-05-Exception-Resolution.md (was FileAsset-Upload-Verify)
  - INDEX.md
- [x] Ensure all paths/roles/status values are truth-aligned.
**Proof**
- [x] `node scripts/consistency.mjs` -> PASS (no drift)
- [x] Manual PASS notes recorded for at least one GP

---

## P2: Design System Migration (Tokens + UI Normalization)

### SSI-0110: Phase 4-7 Token Adoption (Core UI)
- [x] Implement radius tokens (4/8/12/16) in globals + Tailwind
- [x] Update typography scale (display/h1/h2/h3/body-lg/body/caption/overline)
- [x] Normalize core UI components (button/input/textarea/card/dialog/alert-dialog/table/badge)
- [x] Normalize overlays/menus (dropdown/select/popover/tooltip/toast)
- [x] Normalize dashboard cards (bank-vs-invoices, pending-items, suppliers)
**Proof**
- [x] `node scripts/truth.mjs` -> PASS
- [x] `node scripts/consistency.mjs` -> PASS
- [x] `npm run lint` -> PASS (warn: unused formatMoney in exports page)
- [x] `npm run typecheck` -> PASS (R-0001 resolved: Next.js 15 params Promise fix)
- [x] `firebase emulators:exec --only firestore "npm test"` -> 569 passed, 0 failed (R-0002 resolved)

---

## P0/P1: Invariant Test Suite (COMPLETED)

### SSI-0040: Add Invariant Tests Harness
- [x] Create `tests/invariants/README.md`
- [x] Ensure tests run in emulator context (same harness as existing tests).
**Proof**
- [x] `firebase emulators:exec --only firestore "npm test"` -> PASS

### SSI-0041: Tenant Isolation Invariants
- [x] Add `tests/invariants/tenant-isolation.test.ts`:
  - denies cross-tenant reads/writes on each core collection path model
**Proof**
- [x] Emulator tests PASS

### SSI-0042: Status Transition Invariants
- [x] Add `tests/invariants/status-transitions.test.ts`:
  - allowed transitions PASS
  - denied transitions DENIED
  - finalized immutability enforced if truth indicates FINALIZED
**Proof**
- [x] Emulator tests PASS

### SSI-0043: Forbidden Client Fields Invariants
- [x] Add `tests/invariants/server-only-writes.test.ts`:
  - client cannot set privileged statuses/flags/timestamps/actors/totals
- [x] Add `tests/invariants/rbac.test.ts`:
  - role-based access enforcement
**Proof**
- [x] Emulator tests PASS

---

## P0: Release Discipline Enforcement (COMPLETED)

### SSI-0050: Enforce "No Proof Pending"
- [x] Update `agent/RELEASE.md` rules if needed:
  - entries only after PASS proofs
- [x] QA agent enforces RELEASE discipline across all sessions
**Proof**
- [x] No release entry exists without command + PASS results summary

---

## After Gates: Product SSIs (Only once anti-drift is enforced)

## P0: Counterfactual Month Close + EU Views (Phase 6) (COMPLETED)

### SSI-0300: Contract Spec + ADR
- [x] Add counterfactual contract spec (events, money, VAT, definitions)
- [x] Add ADR for event-sourced period/readmodel approach
- [x] Update TASKS with SSIs and proofs
**Proof**
- [x] `npm run typecheck` -> PASS

### SSI-0301: Domain Event Types + Money/VAT Contracts (Pure)
- [x] Add event discriminated unions and payload schemas in server domain
- [x] Add counterfactual timeline types and variance metric helpers
- [x] Unit tests for all new pure domain logic (100% coverage)
**Proof**
- [x] `npm test -- server/tests/domain` -> PASS

### SSI-0302: Counterfactual Close + Close Friction Metrics (Pure)
- [x] Implement counterfactual recompute from events with cutoff
- [x] Implement close friction index metrics from timeline
- [x] Unit tests for all new pure logic (100% coverage)
**Proof**
- [x] `npm test -- server/tests/logic/counterfactual*` -> PASS

### SSI-0303: VAT Summary + Mismatch Detector (Pure)
- [x] Implement period VAT summary by rate buckets
- [x] Implement mismatch detector (bank vs invoices)
- [x] Unit tests for VAT + mismatch logic (100% coverage)
**Proof**
- [x] `npm test -- server/tests/logic/vatSummary*` -> PASS
- [x] `npm test -- server/tests/logic/mismatch*` -> PASS

### SSI-0304: Read Models (Pure Builders)
- [x] Implement readmodels for timeline, friction, vat, mismatch, auditor replay
- [x] Unit tests for readmodel builders (100% coverage)
**Proof**
- [x] `npm test -- server/tests/readmodels` -> PASS

### SSI-0305: Exports (CSV + PDF Generators)
- [x] Implement ledger CSV export with deterministic ordering
- [x] Implement VAT report CSV and summary PDF (deterministic)
- [x] Snapshot tests for exports
**Proof**
- [x] `npm test -- server/tests/exports` -> PASS

### SSI-0306: Workflow Orchestrator + Idempotency
- [x] Add period finalized workflow for readmodels + exports
- [x] Add job records for idempotency with periodLockHash
- [x] Integration tests for idempotency and rebuildability
**Proof**
- [x] `npm test -- server/tests/workflows/periodFinalized*` -> PASS
- [x] `firebase emulators:exec --only firestore "npm test"` -> PASS

### SSI-0307: Read-Only APIs + RBAC
- [x] Add read-only endpoints for auditor replay, VAT summary, mismatch, timeline
- [x] Authorization checks at boundary, no writes
- [x] Endpoint tests
**Proof**
- [x] `npm test -- server/tests/api` -> PASS (8/8)

### SSI-0308: Firestore Rules + Contracts + Seed Updates
- [x] Add rules for events, periods, readmodels, exports
- [x] Update contracts and seed examples
- [x] Emulator rule tests for new collections
**Proof**
- [x] `node scripts/truth.mjs` -> PASS
- [x] `node scripts/consistency.mjs` -> PASS
- [x] `firebase emulators:exec --only firestore "npm test"` -> PASS

### SSI-0100: Close Remaining Test/Build Blockers (Repo Specific) (COMPLETED)
- [x] Fix Typecheck blockers with no runtime behavior change (SSI-level)
- [x] Fix subpackage build issues (functions/calybra-database)
**Proof**
- [x] `npm run typecheck` PASS
- [x] `npm --prefix calybra-database run build` PASS
- [x] `firebase emulators:exec --only firestore "npm test"` PASS

---

## P1: Phase 3 - UX-Driven Orchestration (COMPLETED)

### SSI-0200: Client Orchestration Layer
- [x] Create `/src/client/orchestration/intent.ts` - User intent types and factories
- [x] Create `/src/client/orchestration/guards.ts` - Permission and state validation
- [x] Create `/src/client/orchestration/actions.ts` - Intent-to-workflow dispatch
- [x] Create `/src/client/orchestration/index.ts` - Module exports
**Proof**
- [x] Intent types are explicit, typed, immutable (Object.freeze)
- [x] Guards run synchronously before network calls

### SSI-0201: Event System
- [x] Create `/src/client/events/progress.ts` - Workflow progress tracking
- [x] Create `/src/client/events/errors.ts` - Structured error handling with 30+ codes
- [x] Create `/src/client/events/explanations.ts` - Human-readable status explanations
- [x] Create `/src/client/events/index.ts` - Module exports
**Proof**
- [x] ProgressEmitter tracks step-by-step workflow execution
- [x] Errors include category, user message, recovery guidance, retryable flag

### SSI-0202: State Management
- [x] Create `/src/client/state/selectors.ts` - Derived state from Firestore
- [x] Create `/src/client/state/projections.ts` - UI-ready data projections
- [x] Create `/src/client/state/index.ts` - Module exports
**Proof**
- [x] Selectors compute urgency, flow phase, allowed actions
- [x] Projections are computed, not stored

### SSI-0203: Workflow Actions
- [x] Create `/src/client/workflows/ingestFile.action.ts` - File upload
- [x] Create `/src/client/workflows/parseFile.action.ts` - File parsing
- [x] Create `/src/client/workflows/match.action.ts` - Matching operations
- [x] Create `/src/client/workflows/createInvoice.action.ts` - Invoice creation
- [x] Create `/src/client/workflows/monthClose.action.ts` - Month close lifecycle
- [x] Create `/src/client/workflows/index.ts` - Module exports
**Proof**
- [x] Each action validates, guards, then calls Cloud Function
- [x] All actions return structured ActionResult

### SSI-0204: UX Flow Components
- [x] Create `/src/client/ui/flows/FileIngestionFlow.tsx` - File upload/parse flow
- [x] Create `/src/client/ui/flows/MatchingFlow.tsx` - Match review flow
- [x] Create `/src/client/ui/flows/InvoiceFlow.tsx` - Invoice creation flow
- [x] Create `/src/client/ui/flows/MonthCloseFlow.tsx` - Month close lifecycle flow
- [x] Create `/src/client/ui/flows/index.ts` - Module exports
**Proof**
- [x] Render props pattern provides controlled interface
- [x] Hook API for simpler usage patterns
- [x] All flows observable, explainable, interruptible

### SSI-0205: Orchestration Tests
- [x] Create `/src/client/__tests__/orchestration.test.ts`
- [x] Test intent creation and immutability
- [x] Test guard permission checks
- [x] Test guard state checks
- [x] Test progress event emission
- [x] Test error handling structure
- [x] Test orchestration isolation (UI cannot bypass)
**Proof**
- [x] Tests prove: 1 intent = 1 workflow, invalid blocked, progress emitted, failures surface

### SSI-0206: Phase 3 Documentation
- [x] Create `/agent/PHASE_3_COMPLETION.md`
- [x] Document architecture, guarantees, files created
- [x] Document known limitations and migration path
- [x] Update TASKS.md with Phase 3 SSIs
**Proof**
- [x] PHASE_3_COMPLETION.md exists with complete details

---

## P1: Phase 2.5 - Observability & Telemetry (COMPLETED)

### SSI-0250: Observability Architecture & ADR
- [x] Create ADR-0011 for observability layer design
- [x] Define fundamental invariants (shadow principle, non-blocking, read-only)
- [x] Document integration approach with existing workflows
**Proof**
- [x] ADR-0011 added to `agent/DECISIONS.md`

### SSI-0251: TraceContext Module
- [x] Create `/observability/context/traceContext.ts` - Global trace context
- [x] Implement trace ID generation (tr_prefix format)
- [x] Implement trace propagation via headers
- [x] Ensure immutability (Object.freeze)
- [x] Add null trace context for graceful degradation
**Proof**
- [x] `npx tsc --project observability/tsconfig.json --noEmit` -> PASS

### SSI-0252: WorkflowContext Module
- [x] Create `/observability/context/workflowContext.ts` - Workflow execution context
- [x] Implement workflow execution ID generation (wf_prefix format)
- [x] Support multi-request workflow spans
- [x] Metadata-only (never persisted as authoritative state)
**Proof**
- [x] TypeScript compiles without errors

### SSI-0253: Structured Logging Module
- [x] Create `/observability/logging/logSchema.ts` - Log entry schema
- [x] Create `/observability/logging/logger.ts` - Logger implementation
- [x] Mandatory fields: level, timestamp, traceId, actor, component, operation, result
- [x] Forbidden patterns check (no PII, no secrets)
- [x] Logger NEVER throws (silent failure handling)
- [x] BufferedLogger for batch export
**Proof**
- [x] Logger tests pass, never throws

### SSI-0254: Metrics Module (Timers & Counters)
- [x] Create `/observability/metrics/timers.ts` - Wall-clock timing
- [x] Create `/observability/metrics/counters.ts` - Occurrence counting
- [x] timedSync/timedAsync preserve error behavior
- [x] TimingCollector and CounterRegistry for aggregation
- [x] Standard counter names for consistency
**Proof**
- [x] Timer tests prove errors are re-thrown

### SSI-0255: Tracing Module (Spans)
- [x] Create `/observability/tracing/tracer.ts` - Span-based tracing
- [x] tracedSync/tracedAsync preserve error behavior
- [x] SpanCollector for recording
- [x] Trace reconstruction utilities
**Proof**
- [x] Span tests prove errors are re-thrown with status=ERROR

### SSI-0256: Status Transition Observation
- [x] Create `/observability/transitions/observer.ts` - Read-only observation
- [x] NEVER validates, blocks, or fixes transitions
- [x] Records AFTER transitions happen
- [x] Timeline and statistics utilities
**Proof**
- [x] Observation tests prove no interference

### SSI-0257: Error Telemetry
- [x] Create `/observability/errors/telemetry.ts` - Error capture
- [x] Captures AFTER errors occur
- [x] Preserves original error (never transforms)
- [x] Never throws telemetry errors upward
- [x] Severity classification heuristics
**Proof**
- [x] Error tests prove re-throwing preserved

### SSI-0258: Non-Interference Tests
- [x] Create `/observability/tests/non-interference.test.ts`
- [x] 30 tests proving:
  - Business logic identical with/without observability
  - Telemetry failures don't break workflows
  - Errors are re-thrown (control flow preserved)
  - Collectors handle overflow gracefully
  - Trace/workflow contexts are immutable
**Proof**
- [x] `npx jest observability/tests --no-coverage` -> 30/30 PASS

### SSI-0259: Telemetry Schema Documentation
- [x] Create `/observability/TELEMETRY_SCHEMA.md`
- [x] Document all telemetry types and schemas
- [x] Include example complete workflow trace
- [x] Document integration patterns
**Proof**
- [x] Documentation complete with examples

### SSI-0260: Proof of No Behavior Change
- [x] Run existing server tests to verify no regressions
- [x] TypeScript compilation passes
- [x] No changes to firestore.rules, storage.rules, status machines
**Proof**
- [x] `npx jest server/tests --no-coverage` -> 151/151 PASS
- [x] `npx tsc --project observability/tsconfig.json --noEmit` -> PASS
- [x] firestore.rules, storage.rules unchanged
- [x] Status machines unchanged

### SSI-0261: Observability 2030 Enhancements (Async Context, OTEL, Streaming, Privacy, SLO)
- [x] Export async context helpers from `/observability/context/index.ts`
- [x] Export OTEL formats from `/observability/export/index.ts`
- [x] Export streaming, privacy, and SLO modules from root `/observability/index.ts`
- [x] Add tests for async context propagation
- [x] Add tests for OTEL export formatting
- [x] Add tests for progress streaming isolation
- [x] Add tests for privacy scrubbing rules
- [x] Add tests for SLO budget violations
**Proof**
- [x] `npx tsc --project observability/tsconfig.json --noEmit` -> PASS
- [x] `npx jest observability/tests --no-coverage` -> PASS

---

## Completed
(Only move items here after executed proofs and, if shipping, a RELEASE entry with PASS results.)
