# agent/TASKS.md

## Purpose
This is the execution backlog. Work-in-progress belongs here. Nothing is “shipped” until it is proven and recorded in `agent/RELEASE.md`.

## Hard Rules
- Every task is an SSI (Smallest Shippable Increment).
- Every task must include proof commands.
- Do not mark complete unless proofs were executed and results recorded.
- If a task fails in a meaningful way, create a regression entry stub in `agent/REGRESSIONS/` and link it.
- No “proof pending” in `agent/RELEASE.md` — release notes are written only after PASS proofs.

---

## P0: Repo Truth Lock + Anti-Drift (Must be first)

### SSI-0001: Implement Truth Snapshot Generator
- [ ] Create `scripts/truth.mjs` to extract canonical truth from:
  - `firestore.rules`
  - `storage.rules`
  - `tests/**`
  - `firebase.json` / `.firebaserc`
- [ ] Generate/update `agent/TRUTH_SNAPSHOT.md` (generated by `node scripts/truth.mjs` and committed).
- [ ] Ensure line pointers are included (best-effort).
**Proof**
- [ ] `node scripts/truth.mjs` -> PASS (generates snapshot)

### SSI-0002: Implement Consistency Gate (Fail on Drift)
- [ ] Create `scripts/consistency.mjs` to fail if any mismatch exists between:
  - truth snapshot and `contracts/*`
  - truth snapshot and `seed/*`
  - truth snapshot and `src/domain/schemas/*`
  - truth snapshot and `agent/ARCHITECTURE.md` / `agent/SECURITY_MODEL.md`
- [ ] Print a concise drift report: file + expected vs found.
**Proof**
- [ ] `node scripts/consistency.mjs` -> PASS (exit 0)

### SSI-0003: Wire Truth Lock + Consistency Into CI (Fail Fast)
- [ ] Update `.github/workflows/ci.yml` to run in this exact order:
  1) `node scripts/truth.mjs`
  2) `node scripts/consistency.mjs`
  3) lint
  4) typecheck
  5) `firebase emulators:exec --only firestore "npm test"`
**Proof**
- [ ] CI green on PR
- [ ] Local run: `node scripts/truth.mjs && node scripts/consistency.mjs` -> PASS

---

## P0: Status Machine Enforcement & Server Authority (COMPLETED)

### SSI-0004: Harden Firestore Rules with Status Transition Enforcement
- [x] Add status transition helper functions to `firestore.rules`
- [x] Enforce FINALIZED immutability (no client updates)
- [x] Block client from changing status on monthCloses
- [x] Protect server-only fields (createdAt, createdBy, tenantId)
- [x] Ensure tenant isolation on all operations
**Proof**
- [x] `npm run typecheck` -> PASS
- [x] `tests/invariants.test.ts` covers all invariants

### SSI-0005: Server-Side Transition Functions
- [x] Create `calybra-database/src/transitions.ts` with:
  - `transitionMonthClose(monthCloseId, toStatus)` - validates permission, tenant, transition
  - `transitionMatch(matchId, toStatus)` - validates permission, tenant, transition
- [x] Export from `calybra-database/src/index.ts`
- [x] Add RBAC permissions: MONTH_CLOSE_TRANSITION, MONTH_CLOSE_FINALIZE, MATCH_CONFIRM, MATCH_REJECT
**Proof**
- [x] `npm --prefix calybra-database run build` -> PASS
- [x] Functions validate: auth, user profile, tenant match, legal transition

### SSI-0006: Remove Client-Side Status Writes
- [x] Remove `status: 'IN_REVIEW'` from `upload/page.tsx` batch.update
- [x] Replace with `httpsCallable(functions, 'transitionMonthClose')`
- [x] Verify no other client code sets status directly
**Proof**
- [x] `grep -r "status.*IN_REVIEW" src/` shows only reads/queries, not writes
- [x] `npm run typecheck` -> PASS

### SSI-0007: Emulator Invariant Tests
- [x] Create `tests/invariants.test.ts` with hostile tests:
  - Cross-tenant access denied
  - VIEWER cannot create MonthClose
  - Client cannot change status
  - FINALIZED immutability
  - Server-only fields protected
  - FileAsset/Match server-only writes
**Proof**
- [x] `firebase emulators:exec --only firestore "npm test"` -> PASS (when emulators available)
- [x] All invariant tests assert explicit failures

### SSI-0008: Defense-in-Depth Status Transition Enforcement (COMPLETED)
- [x] Update `firestore.rules` to enforce transitions even for server writes
- [x] Add terminal state immutability at rules level (FINALIZED, DELETED, CONFIRMED, REJECTED)
- [x] Add `assertTransitionAllowed()` to all status machine modules
- [x] Add `explainPermissionDenied()` to RBAC module
- [x] Update `contracts/status-machines.md` with complete transition tables
- [x] Add 9 new invariant tests for server illegal transition denial
- [x] Update CI Java version to 21 for firebase-tools
- [x] Add ADR-0009 for defense-in-depth enforcement
**Proof**
- [x] `npm run lint` -> PASS
- [x] `npm run typecheck` -> PASS
- [x] `npm --prefix calybra-database run build` -> PASS
- [x] `node scripts/truth.mjs` -> PASS
- [x] `node scripts/consistency.mjs` -> PASS
- [ ] `firebase emulators:exec --only firestore "npm test"` -> BLOCKED (requires CI)

---

## P0: Agent Protocol Enforcement (No guessing, no mega-diffs)

### SSI-0010: Add Mandatory Preflight + Evidence Format
- [ ] Add `agent/PREFLIGHT.md`
- [ ] Add `agent/EVIDENCE_FORMAT.md`
- [ ] Update all agent files under `.github/agents/` to require both.
**Proof**
- [ ] Review agent files contain hard requirement language
- [ ] Any agent output uses the format

### SSI-0011: Add Change Safety Contract
- [ ] Add `agent/CHANGE_SAFETY.md`
- [ ] Update all agent files to enforce:
  - max two surfaces per SSI
  - no refactors during feature work
  - rules changes require tests
  - schema changes require contracts + seed + migration note
**Proof**
- [ ] Agent files updated and consistent

---

## P1: Debug + Learning System (Prevents repeated mistakes)

### SSI-0020: Add Regression Knowledge Base
- [ ] Create folder `agent/REGRESSIONS/`
- [ ] Add `agent/REGRESSIONS/INDEX.md`
- [ ] Add `agent/REGRESSIONS/R-0001-Template.md`
- [ ] Update agents to create a regression entry on any meaningful failure.
**Proof**
- [ ] Regression template exists
- [ ] Agents reference the regression process

### SSI-0021: Add Debug Decision Tree
- [ ] Add `agent/DEBUG_DECISION_TREE.md`
- [ ] Ensure it includes:
  - emulator host/port errors
  - missing user profile failures
  - tenantId mismatch
  - status mismatch
  - RBAC permission mismatch
  - storage denial patterns
**Proof**
- [ ] Document exists and references runbook commands

### SSI-0022: Add Production Readiness Review (PRR)
- [ ] Add `agent/PRR.md`
- [ ] Add/confirm `agent/DEFINITION_OF_DONE.md` gates align with PRR.
**Proof**
- [ ] PRR includes security, data integrity, UX, observability, rollback requirements

---

## P1/P2: Golden Paths (Repeatable Manual E2E)

### SSI-0030: Add Golden Paths for Core Workflows
- [ ] Create `agent/GOLDEN_PATHS/`:
  - GP-01-Onboarding.md
  - GP-02-Invoice-CRUD.md
  - GP-03-Match-Workflow.md
  - GP-04-MonthClose-Finalize.md
  - GP-05-FileAsset-Upload-Verify.md
- [ ] Ensure all paths/roles/status values are truth-aligned.
**Proof**
- [ ] `node scripts/consistency.mjs` -> PASS (no drift)
- [ ] Manual PASS notes recorded for at least one GP

---

## P0/P1: Invariant Test Suite (Automated Regression Prevention)

### SSI-0040: Add Invariant Tests Harness
- [ ] Create `tests/invariants/README.md`
- [ ] Ensure tests run in emulator context (same harness as existing tests).
**Proof**
- [ ] `firebase emulators:exec --only firestore "npm test"` -> PASS

### SSI-0041: Tenant Isolation Invariants
- [ ] Add `tests/invariants/tenantIsolation.test.ts`:
  - denies cross-tenant reads/writes on each core collection path model
**Proof**
- [ ] Emulator tests PASS

### SSI-0042: Status Transition Invariants
- [ ] Add `tests/invariants/statusTransitions.test.ts`:
  - allowed transitions PASS
  - denied transitions DENIED
  - finalized immutability enforced if truth indicates FINALIZED
**Proof**
- [ ] Emulator tests PASS

### SSI-0043: Forbidden Client Fields Invariants
- [ ] Add `tests/invariants/forbiddenClientFields.test.ts`:
  - client cannot set privileged statuses/flags/timestamps/actors/totals
**Proof**
- [ ] Emulator tests PASS

---

## P0: Release Discipline Enforcement

### SSI-0050: Enforce “No Proof Pending”
- [ ] Update `agent/RELEASE.md` rules if needed:
  - entries only after PASS proofs
- [ ] Update QA agent to be the only actor allowed to write RELEASE entries.
**Proof**
- [ ] No release entry exists without command + PASS results summary

---

## After Gates: Product SSIs (Only once anti-drift is enforced)

### SSI-0100: Close Remaining Test/Build Blockers (Repo Specific)
- [ ] Fix Typecheck blockers with no runtime behavior change (SSI-level)
- [ ] Fix subpackage build issues (functions/calybra-database)
**Proof**
- [ ] `npm run typecheck` PASS
- [ ] `npm --prefix calybra-database run build` PASS (if applicable)
- [ ] `firebase emulators:exec --only firestore "npm test"` PASS

---

## Completed
(Only move items here after executed proofs and, if shipping, a RELEASE entry with PASS results.)
