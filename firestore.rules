
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function getUserTenantId() {
      // This function is only safe to call for existing users whose user doc has been created.
      return getUserData().tenantId;
    }

    function isTenantMember(tenantId) {
       return isSignedIn() && getUserTenantId() == tenantId;
    }

    // A more generic check for reading/updating/deleting existing tenant-scoped resources.
    function isResourceOwner() {
      return isTenantMember(resource.data.tenantId);
    }

    // A more generic check for creating new tenant-scoped resources.
    function isRequestingOwner() {
      return isTenantMember(request.resource.data.tenantId);
    }

    // Placeholder for future implementation of write-protection on locked months
    function isMonthLocked(monthCloseId) {
      // return get(/databases/$(database)/documents/monthCloses/$(monthCloseId)).data.status == 'LOCKED';
      return false;
    }

    // Default deny all
    match /{path=**} {
      allow read, write: if false;
    }

    // USERS
    // Users can read their own doc.
    // Updates are restricted to prevent self-elevation of roles or tenant switching.
    // Creation and Deletion are forbidden from the client to enforce server-side control.
    match /users/{userId} {
      allow read: if isUser(userId);
      allow create: if false;
      allow update: if isUser(userId) &&
                     // Protect critical fields from being changed by the user
                     request.resource.data.uid == resource.data.uid &&
                     request.resource.data.email == resource.data.email &&
                     request.resource.data.tenantId == resource.data.tenantId &&
                     request.resource.data.role == resource.data.role &&
                     request.resource.data.plan == resource.data.plan &&
                     request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if false;
    }

    // TENANTS
    // Tenants cannot be created, updated, or deleted from the client.
    // They can only be read by a member of that tenant.
    match /tenants/{tenantId} {
      allow create: if false;
      allow read: if isTenantMember(tenantId);
      allow update: if false;
      allow delete: if false;
    }

    // AUDIT EVENTS: Create-only, append-only
    // An authenticated user can create an audit event for their own tenant.
    match /auditEvents/{eventId} {
      allow create: if isSignedIn() && isRequestingOwner() && request.resource.data.createdAt == request.time;
      allow read, update, delete: if false;
    }

    // MATCHES: Client-side finalization protection placeholder
    match /matches/{matchId} {
        allow write: if isSignedIn() &&
                      isRequestingOwner() &&
                      // The client is NOT allowed to set these server-authoritative fields
                      !('status' in request.resource.data) &&
                      !('finalizedBy' in request.resource.data);
        // Read, update, delete will be covered by the generic tenant-scoped block
    }

    // JOBS: Client can create and read, but only server can update.
    match /jobs/{jobId} {
        allow create: if isSignedIn() && isRequestingOwner();
        allow read: if isSignedIn() && isResourceOwner();
        allow update, delete: if false; // Updates must be server-side only.
    }

    // --- Tenant-Scoped Collections ---
    // This single block covers all tenant-scoped data by checking the 'tenantId' field.
    // It denies writes if the associated month is locked.
    match /{collection}/{docId} {
      // This rule applies to collections like: monthCloses, fileAssets, bankTx, invoices, etc.
      // It does NOT apply to users, tenants, or auditEvents which have their own specific rules.
      allow read: if isSignedIn() && isResourceOwner();

      allow create: if isSignedIn() &&
                     isRequestingOwner() &&
                     (collection == 'monthCloses' || !isMonthLocked(request.resource.data.monthCloseId)); // Check for monthCloseId on create

      allow update, delete: if isSignedIn() &&
                             isResourceOwner() &&
                             (collection == 'monthCloses' || !isMonthLocked(resource.data.monthCloseId)); // Check for monthCloseId on update/delete
    }
  }
}
