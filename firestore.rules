
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserTenantId() {
      // This function is only safe to call for existing users whose user doc has been created.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
    }

    function isTenantMember(tenantId) {
       return isSignedIn() && getUserTenantId() == tenantId;
    }

    // A more generic check for reading/updating/deleting existing tenant-scoped resources.
    function isResourceOwner() {
      return isTenantMember(resource.data.tenantId);
    }
    
    // A more generic check for creating new tenant-scoped resources.
    function isRequestingOwner() {
      return isTenantMember(request.resource.data.tenantId);
    }

    // Placeholder for future implementation of write-protection on locked months
    function isMonthLocked(monthCloseId) {
      // return get(/databases/$(database)/documents/monthCloses/$(monthCloseId)).data.status == 'LOCKED';
      return false; 
    }

    // Default deny all
    match /{path=**} {
      allow read, write: if false;
    }

    // USERS
    // A user can create their own user document and read/update it.
    // Nobody can delete user documents.
    match /users/{userId} {
      allow create, read, update: if isUser(userId);
      allow delete: if false;
    }

    // TENANTS
    // A user can create a tenant if they set themselves as the owner.
    // They can read/update it only if they are a member of that tenant.
    match /tenants/{tenantId} {
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow read, update: if isTenantMember(tenantId);
      allow delete: if false; // Tenants should not be deletable through the client.
    }

    // AUDIT EVENTS: Create-only, append-only
    // An authenticated user can create an audit event for their own tenant.
    match /auditEvents/{eventId} {
      allow create: if isSignedIn() && isRequestingOwner() && request.resource.data.createdAt == request.time;
      allow read, update, delete: if false;
    }

    // MATCHES: Client-side finalization protection placeholder
    match /matches/{matchId} {
        allow write: if isSignedIn() &&
                      isRequestingOwner() &&
                      // The client is NOT allowed to set these server-authoritative fields
                      !('status' in request.resource.data) &&
                      !('finalizedBy' in request.resource.data);
        // Read, update, delete will be covered by the generic tenant-scoped block
    }


    // --- Tenant-Scoped Collections ---
    // This single block covers all tenant-scoped data by checking the 'tenantId' field.
    // It denies writes if the associated month is locked.
    match /{collection}/{docId} {
      // This rule applies to collections like: monthCloses, fileAssets, bankTx, invoices, etc.
      // It does NOT apply to users, tenants, or auditEvents which have their own specific rules.
      allow read: if isSignedIn() && isResourceOwner();

      allow create: if isSignedIn() &&
                     isRequestingOwner() &&
                     !isMonthLocked(request.resource.data.monthCloseId); // Check for monthCloseId on create

      allow update, delete: if isSignedIn() &&
                             isResourceOwner() &&
                             !isMonthLocked(resource.data.monthCloseId); // Check for monthCloseId on update/delete
    }
  }
}
